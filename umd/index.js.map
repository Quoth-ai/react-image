{"version":3,"file":"index.js","sources":["../jsSrc/useImage.js","../jsSrc/imagePromiseFactory.js","../jsSrc/Img.js"],"sourcesContent":["import { useState } from 'react';\nimport imagePromiseFactory from './imagePromiseFactory';\nconst removeBlankArrayElements = (a) => a.filter((x) => x);\nconst stringToArray = (x) => (Array.isArray(x) ? x : [x]);\nconst cache = {};\n// sequential map.find for promises\nconst promiseFind = (arr, promiseFactory) => {\n    const srcLength = arr.length;\n    let done = false;\n    return new Promise((resolve, reject) => {\n        const queueNext = (src, isLastSrc) => {\n            return promiseFactory(src, isLastSrc).then(() => {\n                done = true;\n                resolve(src);\n            });\n        };\n        arr\n            .reduce((p, src, index) => {\n            // ensure we aren't done before enquing the next source\n            return p.catch(() => {\n                // index + 1 because we start operation from second item of array \n                const isLasutSrc = index + 1 === srcLength - 1;\n                if (!done)\n                    return queueNext(src, isLasutSrc);\n            });\n        }, queueNext(arr.shift(), srcLength === 1))\n            .catch(reject);\n    });\n};\nexport default function useImage({ srcList, imgPromise, useSuspense = true, loadTimeout }) {\n    const imgLoadPromise = imgPromise ?? imagePromiseFactory({ decode: true, loadTimeout });\n    const [, setIsLoading] = useState(true);\n    const sourceList = removeBlankArrayElements(stringToArray(srcList));\n    const sourceKey = sourceList.join('');\n    if (!cache[sourceKey]) {\n        // create promise to loop through sources and try to load one\n        cache[sourceKey] = {\n            promise: promiseFind(sourceList, imgLoadPromise),\n            cache: 'pending',\n            error: null,\n        };\n    }\n    // when promise resolves/reject, update cache & state\n    cache[sourceKey].promise\n        // if a source was found, update cache\n        // when not using suspense, update state to force a rerender\n        .then((src) => {\n        cache[sourceKey] = { ...cache[sourceKey], cache: 'resolved', src };\n        if (!useSuspense)\n            setIsLoading(false);\n    })\n        // if no source was found, or if another error occured, update cache\n        // when not using suspense, update state to force a rerender\n        .catch((error) => {\n        cache[sourceKey] = { ...cache[sourceKey], cache: 'rejected', error };\n        if (!useSuspense)\n            setIsLoading(false);\n    });\n    if (cache[sourceKey].cache === 'resolved') {\n        return { src: cache[sourceKey].src, isLoading: false, error: null };\n    }\n    if (cache[sourceKey].cache === 'rejected') {\n        if (useSuspense)\n            throw cache[sourceKey].error;\n        return { isLoading: false, error: cache[sourceKey].error, src: undefined };\n    }\n    // cache[sourceKey].cache === 'pending')\n    if (useSuspense)\n        throw cache[sourceKey].promise;\n    return { isLoading: true, src: undefined, error: null };\n}\n//# sourceMappingURL=useImage.js.map","// returns a Promisized version of Image() api\nexport default ({ decode = true, crossOrigin = '', loadTimeout }) => (src, isLastSrc) => {\n    return new Promise((resolve, reject) => {\n        const i = new Image();\n        let timer;\n        if (crossOrigin)\n            i.crossOrigin = crossOrigin;\n        i.onload = () => {\n            clearTimeout(timer);\n            decode && i.decode ? i.decode().then(resolve).catch(reject) : resolve();\n        };\n        i.onerror = reject;\n        i.src = src;\n        if (loadTimeout && !isLastSrc) {\n            timer = setTimeout(() => {\n                i.src = '';\n                reject();\n            }, loadTimeout);\n        }\n    });\n};\n//# sourceMappingURL=imagePromiseFactory.js.map","import React from 'react';\nimport useImage from './useImage';\nimport imagePromiseFactory from './imagePromiseFactory';\nconst passthroughContainer = (x) => x;\nexport default function Img({ decode = true, src: srcList = [], loader = null, unloader = null, container = passthroughContainer, loaderContainer = passthroughContainer, unloaderContainer = passthroughContainer, imgPromise, crossorigin, useSuspense = false, loadTimeout = null, ...imgProps // anything else will be passed to the <img> element\n }) {\n    imgPromise =\n        imgPromise || imagePromiseFactory({ decode, crossOrigin: crossorigin, loadTimeout });\n    const { src, isLoading } = useImage({\n        srcList,\n        imgPromise,\n        useSuspense,\n    });\n    // console.log({src, isLoading, resolvedSrc, useSuspense})\n    // show img if loaded\n    if (src)\n        return container(React.createElement(\"img\", { src: src, ...imgProps }));\n    // show loader if we have one and were still trying to load image\n    if (!useSuspense && isLoading)\n        return loaderContainer(loader);\n    // show unloader if we have one and we have no more work to do\n    if (!useSuspense && unloader)\n        return unloaderContainer(unloader);\n    return null;\n}\n//# sourceMappingURL=Img.js.map"],"names":["useImage","_ref","srcList","imgPromise","_ref$useSuspense","useSuspense","loadTimeout","imgLoadPromise","imagePromiseFactory","decode","useState","setIsLoading","_useState","sourceList","removeBlankArrayElements","stringToArray","sourceKey","join","cache","promise","promiseFind","error","then","src","isLoading","_ref$decode","_ref$crossOrigin","crossOrigin","isLastSrc","Promise","resolve","reject","timer","i","Image","onload","clearTimeout","onerror","setTimeout","a","filter","x","Array","isArray","arr","promiseFactory","srcLength","length","done","queueNext","reduce","p","index","shift","passthroughContainer","_ref$src","_ref$loader","loader","_ref$unloader","unloader","_ref$container","container","_ref$loaderContainer","loaderContainer","_ref$unloaderContaine","unloaderContainer","crossorigin","_ref$loadTimeout","imgProps","_objectWithoutPropertiesLoose","_excluded","_useImage","React"],"mappings":"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"}